rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // FUNCIONES AUXILIARES
    // ========================================
    
    // Verificar si el usuario está autenticado
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Obtener el rol del usuario desde la colección users
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Verificar si el usuario es admin
    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }
    
    // Verificar si el usuario es empleado o admin
    function isEmployeeOrAdmin() {
      return isSignedIn() && (getUserRole() == 'admin' || getUserRole() == 'employee');
    }
    
    // Verificar si el usuario es el propietario del documento
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Validar estructura de datos de usuario
    function isValidUserData() {
      let data = request.resource.data;
      return data.keys().hasAll(['uid', 'email', 'role', 'createdAt']) &&
             data.uid is string &&
             data.email is string &&
             data.role in ['admin', 'employee', 'client'] &&
             data.createdAt is timestamp;
    }
    
    // Validar que no se cambie el rol sin ser admin
    function roleChangeIsValid() {
      return !('role' in request.resource.data) || 
             resource.data.role == request.resource.data.role || 
             isAdmin();
    }
    
    // ========================================
    // COLECCIÓN: users
    // ========================================
    match /users/{userId} {
      // Leer: solo admins pueden ver todos los usuarios
      // Los usuarios pueden ver su propio perfil
      allow read: if isAdmin() || isOwner(userId);
      
      // Crear: solo admins pueden crear usuarios
      allow create: if isAdmin() && isValidUserData();
      
      // Actualizar: admins pueden actualizar cualquier usuario
      // Los usuarios pueden actualizar su propio perfil (excepto el rol)
      allow update: if (isAdmin() || isOwner(userId)) && 
                       isValidUserData() && 
                       roleChangeIsValid();
      
      // Eliminar: solo admins pueden eliminar usuarios
      allow delete: if isAdmin();
    }
    
    // ========================================
    // COLECCIÓN: games (estructura jerárquica)
    // ========================================
    // Estructura: games/{plataforma}/juegos/{juegoId}
    match /games/{plataforma}/juegos/{juegoId} {
      // Leer: empleados y admins pueden ver juegos
      allow read: if isEmployeeOrAdmin();
      
      // Crear: solo admins pueden crear juegos
      allow create: if isAdmin();
      
      // Actualizar: solo admins pueden actualizar juegos
      allow update: if isAdmin();
      
      // Eliminar: solo admins pueden eliminar juegos
      allow delete: if isAdmin();
      
      // ========================================
      // SUB-COLECCIÓN: correos
      // ========================================
      // Estructura: games/{plataforma}/juegos/{juegoId}/correos/{correoId}
      match /correos/{correoId} {
        // Leer: empleados y admins pueden ver correos
        allow read: if isEmployeeOrAdmin();
        
        // Crear: solo admins pueden crear correos
        allow create: if isAdmin();
        
        // Actualizar: empleados y admins pueden actualizar
        // (necesario para eliminar códigos al generar mensajes WhatsApp)
        allow update: if isEmployeeOrAdmin();
        
        // Eliminar: solo admins pueden eliminar correos
        allow delete: if isAdmin();
      }
    }
    
    // ========================================
    // COLECCIÓN: reportes
    // ========================================
    match /reportes/{reporteId} {
      // Leer: solo admins pueden ver todos los reportes
      // Los empleados solo pueden ver sus propios reportes
      allow read: if isAdmin() || 
                     (isEmployeeOrAdmin() && resource.data.uid == request.auth.uid);
      
      // Crear: empleados y admins pueden crear reportes
      // Validar que el uid coincida con el usuario autenticado
      allow create: if isEmployeeOrAdmin() && 
                       request.resource.data.uid == request.auth.uid &&
                       request.resource.data.keys().hasAll([
                         'uid', 'email', 'nombreUsuario', 'rol',
                         'juegoNombre', 'juegoId', 'plataforma',
                         'correoUtilizado', 'codigosUsados',
                         'plataformaMensaje', 'fechaGeneracion', 'createdAt'
                       ]);
      
      // Actualizar: nadie puede actualizar reportes (son inmutables)
      allow update: if false;
      
      // Eliminar: solo admins pueden eliminar reportes (para limpieza)
      allow delete: if isAdmin();
    }
    
    // ========================================
    // COLECCIÓN: carrito (si existe)
    // ========================================
    match /carts/{userId} {
      // Solo el propietario puede leer y escribir su carrito
      allow read, write: if isOwner(userId);
    }
    
    // ========================================
    // COLECCIÓN: pedidos (si existe)
    // ========================================
    match /orders/{orderId} {
      // Los clientes pueden ver sus propios pedidos
      // Los admins pueden ver todos los pedidos
      allow read: if isAdmin() || 
                     (isSignedIn() && resource.data.userId == request.auth.uid);
      
      // Los clientes pueden crear sus propios pedidos
      allow create: if isSignedIn() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Solo admins pueden actualizar pedidos (cambiar estado)
      allow update: if isAdmin();
      
      // Solo admins pueden eliminar pedidos
      allow delete: if isAdmin();
    }
    
    // ========================================
    // DENEGAR TODO LO DEMÁS
    // ========================================
    // Cualquier otra ruta que no coincida con las anteriores será denegada por defecto
  }
}

